<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>OPEN Watchlist — Mobile PWA</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{
    --bg:#0b0f14; --card:#121821; --muted:#8aa0b4; --text:#e7f0f7;
    --accent:#5cc8ff; --red:#ff6b6b; --green:#4cd964; --yellow:#ffd166;
    --border:#1f2a36;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg); color:var(--text); line-height:1.45;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  header{
    position:sticky; top:0; z-index:10; background:rgba(11,15,20,.9);
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border); padding:10px 14px;
  }
  .title{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .badge{padding:4px 8px; border-radius:999px; background:#0f2533; color:var(--accent); font-weight:600; font-size:12px}
  .muted{color:var(--muted); font-size:12px}
  main{max-width:1100px; margin:0 auto; padding:12px 14px}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
  .tab{padding:8px 12px; border-radius:999px; border:1px solid var(--border); cursor:pointer; background:#10171f}
  .tab.active{background:#0f2533; color:#bfeaff}
  .grid{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:900px){ .grid{grid-template-columns:1.1fr .9fr} }

  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.25)}
  h2{margin:0 0 8px 0; font-size:16px}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th, td{border-bottom:1px solid var(--border); padding:8px 6px; text-align:left}
  th{color:#b9c9d9; font-weight:600}
  .right{text-align:right}
  .pill{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--border); margin-right:6px}
  .good{color:var(--green); border-color:rgba(76,217,100,.35)}
  .bad{color:var(--red); border-color:rgba(255,107,107,.35)}
  .warn{color:var(--yellow); border-color:rgba(255,209,102,.35)}
  input{width:100%; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:#0e141c; color:var(--text)}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  button{padding:10px 12px; border-radius:10px; border:1px solid #223444; background:linear-gradient(180deg,#1d2a36,#12202b); color:#d7f1ff; font-weight:700; cursor:pointer}
  .primary{background:linear-gradient(180deg,#0e3a4f,#0b2d3f); border-color:#205a76}
  .small{font-size:12px; color:var(--muted)}
  .alert{border-left:4px solid var(--accent); padding:10px 12px; background:#0f1a24; border-radius:10px; margin:8px 0; display:none}
  .alert.show{display:block}
  .alert.good{border-left-color:var(--green); background:#0f2218}
  .alert.bad{border-left-color:var(--red); background:#201416}
  .section-title{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .tw{min-height:420px}
  .hint{font-size:12px; color:#8aa0b4}
  .install{margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="title">
    <div style="font-weight:900; font-size:18px">OPEN Watchlist — Mobile</div>
    <div class="badge" id="asof">Loading…</div>
  </div>
  <div class="muted install">iPhone: Open in Safari → Share → Add to Home Screen for app-like view.</div>
</header>

<main>
  <div class="tabs">
    <div class="tab active" data-tab="core">Core Watchlist</div>
    <div class="tab" data-tab="penny">Penny Radar</div>
    <div class="tab" data-tab="pl">P/L Calculator</div>
    <div class="tab" data-tab="alerts">Mood & Breakout Alerts</div>
    <div class="tab" data-tab="charts">Live Charts</div>
  </div>

  <div id="panel-core" class="grid">
    <section class="card">
      <div class="section-title">
        <h2>Core Watchlist (auto-refresh)</h2>
        <div class="hint">Updating every 60s. Data via Yahoo Finance (client-side).</div>
      </div>
      <table id="tblCore">
        <thead><tr><th>Ticker</th><th class="right">Price</th><th class="right">Change %</th><th>Notes</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
    <section class="card">
      <h2>Key Zones</h2>
      <div class="pill good">OPEN support: $2.30–2.40</div>
      <div class="pill warn">OPEN breakout: $2.90</div>
      <div class="pill bad">OPEN risk: $1.80 breakdown</div>
      <p class="small">Edit thresholds in Alerts tab.</p>
      <h2 style="margin-top:12px">Macro & Dates</h2>
      <ul>
        <li>Next CPI / mortgage rate update: see Calendar tab in your phone (optional sync).</li>
        <li>FOMC watch: dovish shift is bullish for OPEN & housing beta.</li>
      </ul>
    </section>
  </div>

  <div id="panel-penny" class="grid" style="display:none">
    <section class="card">
      <h2>Penny Radar (under $5)</h2>
      <table id="tblPenny">
        <thead><tr><th>Ticker</th><th class="right">Price</th><th class="right">Change %</th><th>Setup</th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="small">Auto-add requires an API key with a data provider. For now, these are your short-term picks.</p>
    </section>
    <section class="card">
      <h2>New Ideas (manual add)</h2>
      <div class="row">
        <input id="newTicker" placeholder="e.g., KULR">
        <button class="primary" id="btnAddPenny">Add</button>
      </div>
    </section>
  </div>

  <div id="panel-pl" class="grid" style="display:none">
    <section class="card">
      <h2>P/L Calculator (real-time)</h2>
      <table id="tblPL">
        <thead>
          <tr>
            <th>Ticker</th>
            <th class="right">Shares</th>
            <th class="right">Avg Cost</th>
            <th class="right">Price</th>
            <th class="right">Cost</th>
            <th class="right">Value</th>
            <th class="right">P/L $</th>
            <th class="right">P/L %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="btnSavePL" class="primary">Save Holdings</button>
        <button id="btnClearPL">Clear</button>
      </div>
      <p class="small">Your holdings are stored locally on this device only.</p>
    </section>
  </div>

  <div id="panel-alerts" class="grid" style="display:none">
    <section class="card">
      <h2>Mood + Price Rules (OPEN)</h2>
      <div class="row">
        <div style="flex:1">
          <label class="small">Mentions Δ% (15–30m)</label>
          <input id="mentionsDelta" type="number" placeholder="e.g., 45">
        </div>
        <div style="flex:1">
          <label class="small">Breakout level</label>
          <input id="breakoutLv" type="number" value="2.90" step="0.01">
        </div>
        <div style="flex:1">
          <label class="small">Breakdown level</label>
          <input id="breakdownLv" type="number" value="1.80" step="0.01">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnCheck" class="primary">Run Check</button>
        <button id="btnSaveRules">Save Rules</button>
      </div>
      <div class="alert good" id="bullAlert"><strong>BULLISH:</strong> Mentions surge + price ≥ breakout. Consider momentum trade; targets $3.20–$3.50.</div>
      <div class="alert bad" id="bearAlert"><strong>BEARISH:</strong> Mentions plunge + price ≤ breakdown. Consider defense; $1.55–$1.40 risk.</div>
      <div class="alert" id="neutralAlert"><strong>No combined signal.</strong> Watch $2.30 pivot and $2.60 trim zone.</div>
      <p class="small">Tip: enter the mentions change from your sentiment tools; price is pulled live below.</p>
    </section>
  </div>

  <div id="panel-charts" class="grid" style="display:none">
    <section class="card tw">
      <h2>TradingView: OPEN</h2>
      <div class="tv">
        <div class="tradingview-widget-container">
          <div id="tv-open" style="height:380px;"></div>
        </div>
      </div>
    </section>
    <section class="card tw">
      <h2>TradingView: Core tickers</h2>
      <div class="tv"><div id="tv-core" style="height:380px;"></div></div>
    </section>
  </div>
</main>

<script>
const CORE = ["OPEN","LX","BEST","LCID","META","2222.SR"];
const PENNY = ["KULR","SNTG","IONQ","BBIG","GNS"];
const STATE = {
  quotes: {},
  holdings: {},
  lastFetch: 0
};


// Preset your holdings for OPEN if none saved yet
try {
  const hSaved = JSON.parse(localStorage.getItem("holdings")||"null");
  if(!hSaved || !hSaved["OPEN"]){
    STATE.holdings["OPEN"] = {"shares":"15010.2311","cost":"2.24"};
    localStorage.setItem("holdings", JSON.stringify(STATE.holdings));
  }
} catch(e) { /* ignore */ }

STATE.quotes["OPEN"] = { price: 3.29, changePct: 0 };

function fmt(n, dp=2){ return (n===null||n===undefined||isNaN(n)) ? "—" : Number(n).toFixed(dp); }

function setTab(name){
  ["core","penny","pl","alerts","charts"].forEach(t=>{
    document.querySelector(`#panel-${t}`).style.display = (t===name) ? "" : "none";
    const tabBtn = [...document.querySelectorAll(".tab")].find(x=>x.dataset.tab===t);
    if(tabBtn){ tabBtn.classList.toggle("active", t===name); }
  });
  localStorage.setItem("tab", name);
}

document.querySelectorAll(".tab").forEach(el=>{
  el.addEventListener("click", ()=> setTab(el.dataset.tab));
});

function nowStamp(){
  const s = new Date().toLocaleString();
  document.getElementById("asof").textContent = "Updated " + s;
}

async function fetchQuotes(list){
  try{
    const url = "https://query1.finance.yahoo.com/v7/finance/quote?symbols=" + encodeURIComponent(list.join(","));
    const res = await fetch(url);
    const j = await res.json();
    if(!j || !j.quoteResponse || !j.quoteResponse.result) throw new Error("Bad quote data");
    j.quoteResponse.result.forEach(r=>{
      const sym = r.symbol;
      const p = r.regularMarketPrice ?? r.postMarketPrice ?? r.preMarketPrice;
      const ch = r.regularMarketChangePercent ?? 0;
      if(p){ STATE.quotes[sym] = { price: p, changePct: ch }; }
    });
  }catch(e){
    console.warn("Quote fetch failed; using cached/manual values.", e);
  }
}

function renderTables(){
  const coreBody = document.querySelector("#tblCore tbody");
  const pennyBody = document.querySelector("#tblPenny tbody");
  coreBody.innerHTML = "";
  pennyBody.innerHTML = "";

  CORE.forEach(sym=>{
    const q = STATE.quotes[sym] || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${sym}</td>
      <td class="right">${fmt(q.price)}</td>
      <td class="right" style="color:${(q.changePct||0)>=0?'#4cd964':'#ff6b6b'}">${fmt(q.changePct,2)}%</td>
      <td>${sym==='OPEN' ? 'Watch $2.90 / $2.30 / $1.80' : ''}</td>`;
    coreBody.appendChild(tr);
  });

  PENNY.forEach(sym=>{
    const q = STATE.quotes[sym] || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${sym}</td>
      <td class="right">${fmt(q.price)}</td>
      <td class="right" style="color:${(q.changePct||0)>=0?'#4cd964':'#ff6b6b'}">${fmt(q.changePct,2)}%</td>
      <td>Momentum scan</td>`;
    pennyBody.appendChild(tr);
  });
}

function renderPL(){
  const body = document.querySelector("#tblPL tbody");
  body.innerHTML = "";
  const list = [...CORE, ...PENNY];
  list.forEach(sym=>{
    const hold = STATE.holdings[sym] || { shares: "", cost: "" };
    const q = STATE.quotes[sym] || {};
    const shares = parseFloat(hold.shares)||0;
    const cost = parseFloat(hold.cost)||0;
    const price = parseFloat(q.price)||0;
    const totalCost = shares*cost;
    const value = shares*price;
    const pl = value-totalCost;
    const plPct = totalCost>0 ? (pl/totalCost*100) : 0;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${sym}</td>
      <td class="right"><input data-sym="${sym}" data-k="shares" value="${hold.shares}" placeholder="0"></td>
      <td class="right"><input data-sym="${sym}" data-k="cost" value="${hold.cost}" placeholder="0.00"></td>
      <td class="right">${fmt(price)}</td>
      <td class="right">${fmt(totalCost)}</td>
      <td class="right">${fmt(value)}</td>
      <td class="right" style="color:${pl>=0?'#4cd964':'#ff6b6b'}">${fmt(pl)}</td>
      <td class="right" style="color:${pl>=0?'#4cd964':'#ff6b6b'}">${fmt(plPct,2)}%</td>`;
    body.appendChild(tr);
  });

  body.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const sym = inp.dataset.sym, k = inp.dataset.k;
      STATE.holdings[sym] = STATE.holdings[sym]||{};
      STATE.holdings[sym][k]= inp.value;
      localStorage.setItem("holdings", JSON.stringify(STATE.holdings));
      renderPL();
    });
  });
}

async function tick(){
  const symbols = [...CORE, ...PENNY];
  await fetchQuotes(symbols);
  renderTables();
  renderPL();
  nowStamp();
}

document.getElementById("btnSavePL").addEventListener("click", ()=>{
  localStorage.setItem("holdings", JSON.stringify(STATE.holdings));
  nowStamp();
});
document.getElementById("btnClearPL").addEventListener("click", ()=>{
  STATE.holdings = {};
  localStorage.removeItem("holdings");
  renderPL();
});

document.getElementById("btnAddPenny").addEventListener("click", ()=>{
  const v = (document.getElementById("newTicker").value||"").trim().toUpperCase();
  if(v && !PENNY.includes(v)){ PENNY.push(v); localStorage.setItem("penny", JSON.stringify(PENNY)); tick(); }
  document.getElementById("newTicker").value="";
});

document.getElementById("btnCheck").addEventListener("click", ()=>{
  const md = parseFloat(document.getElementById("mentionsDelta").value||"");
  const breakout = parseFloat(document.getElementById("breakoutLv").value||"2.90");
  const breakdown = parseFloat(document.getElementById("breakdownLv").value||"1.80");
  const openPx = (STATE.quotes["OPEN"]?.price) || 0;
  ["bullAlert","bearAlert","neutralAlert"].forEach(id=>document.getElementById(id).classList.remove("show"));
  if(isFinite(md) && isFinite(openPx)){
    if(md>=40 && openPx>=breakout){ document.getElementById("bullAlert").classList.add("show"); }
    else if(md<=-35 && openPx<=breakdown){ document.getElementById("bearAlert").classList.add("show"); }
    else { document.getElementById("neutralAlert").classList.add("show"); }
  }else{
    document.getElementById("neutralAlert").classList.add("show");
  }
});

document.getElementById("btnSaveRules").addEventListener("click", ()=>{
  const data = {
    mentionsDelta: document.getElementById("mentionsDelta").value,
    breakoutLv: document.getElementById("breakoutLv").value,
    breakdownLv: document.getElementById("breakdownLv").value
  };
  localStorage.setItem("rules", JSON.stringify(data));
  nowStamp();
});

(function init(){
  const tab = localStorage.getItem("tab")||"core";
  setTab(tab);
  try{
    const h = JSON.parse(localStorage.getItem("holdings")||"{}");
    STATE.holdings = h;
    const pr = JSON.parse(localStorage.getItem("penny")||"null");
    if(pr && Array.isArray(pr)) { PENNY.splice(0, PENNY.length, ...pr); }
    const rules = JSON.parse(localStorage.getItem("rules")||"null");
    if(rules){
      document.getElementById("mentionsDelta").value = rules.mentionsDelta||"";
      document.getElementById("breakoutLv").value = rules.breakoutLv||"2.90";
      document.getElementById("breakdownLv").value = rules.breakdownLv||"1.80";
    }
  }catch(e){}
  tick();
  setInterval(tick, 60000);
})();
</script>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
  new TradingView.widget({
    "autosize": true,
    "symbol": "NASDAQ:OPEN",
    "interval": "15",
    "timezone": "Etc/UTC",
    "theme": "dark",
    "style": "1",
    "locale": "en",
    "toolbar_bg": "#0b0f14",
    "enable_publishing": false,
    "hide_top_toolbar": false,
    "hide_legend": false,
    "container_id": "tv-open"
  });
  new TradingView.widget({
    "autosize": true,
    "symbols": [
      ["OPEN","NASDAQ:OPEN"],
      ["LX","NASDAQ:LX"],
      ["BEST","NYSE:BEST"],
      ["LCID","NASDAQ:LCID"],
      ["META","NASDAQ:META"],
      ["ARAMCO","TADAWUL:2222"]
    ],
    "theme": "dark",
    "timezone": "Etc/UTC",
    "locale": "en",
    "container_id": "tv-core",
    "gridLineColor": "#1f2a36"
  });
</script>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
</script>
</body>
</html>
