<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>OPEN Watchlist — Hybrid (Rescue)</title>
<meta name="theme-color" content="#0b0f14">
<style>
  :root{ --bg:#0b0f14; --card:#121821; --muted:#8aa0b4; --text:#e7f0f7; --accent:#5cc8ff; --red:#ff6b6b; --green:#4cd964; --border:#1f2a36; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:rgba(11,15,20,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:10px 14px}
  .title{display:flex;align-items:center;justify-content:space-between}
  .badge{padding:4px 8px;border-radius:999px;background:#0f2533;color:#bfeaff;font-size:12px}
  .status{padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:#0e141c;color:var(--muted);font-size:12px;margin-left:8px}
  main{max-width:1100px;margin:0 auto;padding:12px 14px}.grid{display:grid;gap:12px;grid-template-columns:1fr}.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  table{width:100%;border-collapse:collapse;font-size:14px}th,td{border-bottom:1px solid var(--border);padding:8px 6px}th{color:#b9c9d9} .right{text-align:right}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}.tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);cursor:pointer;background:#10171f}.tab.active{background:#0f2533;color:#bfeaff}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center} input{width:100%;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:#0e141c;color:var(--text)}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);margin-right:6px}.good{color:#4cd964}.bad{color:#ff6b6b}
  .muted{color:#8aa0b4;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="title">
    <div style="font-weight:900">OPEN Watchlist — Hybrid (Rescue)</div>
    <div>
      <span class="badge" id="asof">Loading…</span>
      <span class="status" id="status">Source: —</span>
    </div>
  </div>
  <div class="muted">If data fails: click “Set backend” or rely on fallback.</div>
</header>

<main>
  <div class="tabs">
    <div class="tab active" data-tab="core">Core</div>
    <div class="tab" data-tab="penny">Penny</div>
    <div class="tab" data-tab="pl">P/L</div>
    <div class="tab" data-tab="cfg">Config</div>
  </div>

  <div id="panel-core" class="grid">
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3>Watchlist</h3>
        <div><button id="btnSet" style="padding:6px 10px;border-radius:8px;border:1px solid #1f2a36;background:#0e141c;color:#bfeaff;cursor:pointer">Set backend</button></div>
      </div>
      <table id="tblCore"><thead><tr><th>Ticker</th><th class="right">Price</th><th class="right">Chg%</th><th>Notes</th></tr></thead><tbody></tbody></table>
    </section>
  </div>

  <div id="panel-penny" class="grid" style="display:none">
    <section class="card">
      <h3>Penny Radar</h3>
      <table id="tblPenny"><thead><tr><th>Ticker</th><th class="right">Price</th><th class="right">Chg%</th><th>Setup</th></tr></thead><tbody></tbody></table>
    </section>
  </div>

  <div id="panel-pl" class="grid" style="display:none">
    <section class="card">
      <h3>P/L</h3>
      <table id="tblPL"><thead><tr><th>Ticker</th><th class="right">Shares</th><th class="right">Avg Cost</th><th class="right">Price</th><th class="right">Cost</th><th class="right">Value</th><th class="right">P/L $</th><th class="right">P/L %</th></tr></thead><tbody></tbody></table>
    </section>
  </div>

  <div id="panel-cfg" class="grid" style="display:none">
    <section class="card">
      <h3>Config & Troubleshooting</h3>
      <ol>
        <li>Click <strong>Set backend</strong> and paste your Netlify URL (e.g., <code>https://open-realtime.netlify.app</code>).</li>
        <li>If backend fails, the app auto-falls-back to <em>Yahoo via CORS proxy</em>.</li>
        <li>If still broken, your old Service Worker may cache files: on iPhone go Settings → Safari → Advanced → Website Data → search your GitHub Pages domain → Remove.</li>
      </ol>
      <div class="muted" id="lastErr">Last error: —</div>
    </section>
  </div>
</main>

<script>
const CORE = ["OPEN","LX","BEST","LCID","META","2222.SR"];
const PENNY = ["KULR","SNTG","IONQ","BBIG","GNS"];
const STATE = { quotes:{}, holdings:{}, penny:[...PENNY] };

// Prefill your OPEN
STATE.quotes["OPEN"] = { price: 3.29, changePct: 0 };
try{
  const h = JSON.parse(localStorage.getItem("holdings")||"null");
  if(!h || !h["OPEN"]){
    STATE.holdings["OPEN"] = {"shares":"15010.2311","cost":"2.24"};
    localStorage.setItem("holdings", JSON.stringify(STATE.holdings));
  } else { STATE.holdings = h; }
}catch(e){}

function fmt(n, dp=2){ return (n==null||isNaN(n)) ? "—" : Number(n).toFixed(dp); }
function stamp(){ document.getElementById("asof").textContent = "Updated " + new Date().toLocaleString(); }
function setStatus(s){ document.getElementById("status").textContent = "Source: " + s; }
function setErr(e){ document.getElementById("lastErr").textContent = "Last error: " + (e||"—"); }

// Tabs
function setTab(name){ ["core","penny","pl","cfg"].forEach(t=>{
  document.querySelector("#panel-"+t).style.display = (t===name) ? "" : "none";
  [...document.querySelectorAll(".tab")].forEach(el=> el.classList.toggle("active", el.dataset.tab===t));
}); }
document.querySelectorAll(".tab").forEach(el=> el.addEventListener("click", ()=> setTab(el.dataset.tab)));

// Backend base
let BACKEND_BASE = localStorage.getItem("backend_base") || "";
document.getElementById("btnSet").addEventListener("click", ()=>{
  const maybe = prompt("Enter your backend base URL (e.g., https://open-realtime.netlify.app):", BACKEND_BASE);
  if(maybe && /^https?:\/\//.test(maybe)){ BACKEND_BASE = maybe.replace(/\/$/,''); localStorage.setItem("backend_base", BACKEND_BASE); location.reload(); }
});

async function fetchBackendQuotes(list){
  if(!BACKEND_BASE) throw new Error("No BACKEND_BASE set");
  const url = BACKEND_BASE + "/.netlify/functions/quotes?symbols=" + encodeURIComponent(list.join(","));
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("Backend HTTP " + r.status);
  const j = await r.json();
  let found = 0;
  list.forEach(sym=>{
    const q = j.quotes?.[sym];
    if (q && q.price != null) { STATE.quotes[sym] = { price:q.price, changePct:q.changePct }; found++; }
  });
  if(!found) throw new Error("Backend returned 0 quotes");
  setStatus("Backend");
}

async function fetchYahooQuotes(list){
  const PROXY = "https://cors.isomorphic-git.org/";
  const endpoint = "https://query1.finance.yahoo.com/v7/finance/quote?symbols=" + encodeURIComponent(list.join(","));
  const r = await fetch(PROXY + endpoint);
  if(!r.ok) throw new Error("Yahoo HTTP " + r.status);
  const j = await r.json();
  let found = 0;
  (j?.quoteResponse?.result||[]).forEach(row=>{
    const p = row.regularMarketPrice ?? row.postMarketPrice ?? row.preMarketPrice;
    const ch = row.regularMarketChangePercent ?? null;
    if (p != null) { STATE.quotes[row.symbol] = { price:p, changePct:ch }; found++; }
  });
  if(!found) throw new Error("Yahoo returned 0 quotes");
  setStatus("Yahoo (fallback)");
}

async function fetchQuotes(list){
  try{
    await fetchBackendQuotes(list);
  }catch(e){
    setErr(e.message);
    try{ await fetchYahooQuotes(list); }catch(e2){ setErr(e.message + " | " + e2.message); throw e2; }
  }
}

function renderTable(id, syms, setupNote){
  const body = document.querySelector(id+" tbody"); body.innerHTML = "";
  syms.forEach(sym=>{
    const q = STATE.quotes[sym] || {};
    const priceCell = (q.price != null) ? fmt(q.price) : "—";
    const chCell = (q.changePct != null) ? fmt(q.changePct,2)+"%" : "—";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${sym}</td><td class="right">${priceCell}</td><td class="right" style="color:${(q.changePct||0)>=0?'#4cd964':'#ff6b6b'}">${chCell}</td><td>${setupNote||''}</td>`;
    body.appendChild(tr);
  });
}

function renderPL(){
  const body = document.querySelector("#tblPL tbody"); body.innerHTML = "";
  const list = [...CORE, ...PENNY];
  list.forEach(sym=>{
    const hold = STATE.holdings[sym] || { shares:"", cost:"" };
    const q = STATE.quotes[sym] || {};
    const shares = parseFloat(hold.shares)||0, cost = parseFloat(hold.cost)||0, price = parseFloat(q.price)||0;
    const totalCost = shares*cost, value = shares*price, pl = value-totalCost, plPct = totalCost>0 ? (pl/totalCost*100) : 0;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${sym}</td>
      <td class="right"><input data-sym="${sym}" data-k="shares" value="${hold.shares}" placeholder="0"></td>
      <td class="right"><input data-sym="${sym}" data-k="cost" value="${hold.cost}" placeholder="0.00"></td>
      <td class="right">${fmt(price)}</td>
      <td class="right">${fmt(totalCost)}</td>
      <td class="right">${fmt(value)}</td>
      <td class="right" style="color:${pl>=0?'#4cd964':'#ff6b6b'}">${fmt(pl)}</td>
      <td class="right" style="color:${pl>=0?'#4cd964':'#ff6b6b'}">${fmt(plPct,2)}%</td>`;
    body.appendChild(tr);
  });
  body.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const sym = inp.dataset.sym, k = inp.dataset.k;
      STATE.holdings[sym] = STATE.holdings[sym]||{};
      STATE.holdings[sym][k] = inp.value;
      localStorage.setItem("holdings", JSON.stringify(STATE.holdings));
      renderPL();
    });
  });
}

async function tick(){
  const syms = [...CORE, ...PENNY];
  await fetchQuotes(syms);
  renderTable("#tblCore", CORE, "OPEN: $3.50/$2.30/$1.80");
  renderTable("#tblPenny", PENNY, "Momentum");
  renderPL();
  stamp();
}

(async function init(){
  setTab("core");
  await tick();
  setInterval(tick, 60000);
})();
</script>
</body>
</html>
